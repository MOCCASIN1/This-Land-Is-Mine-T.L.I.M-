<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>T.L.I.M! â€“ This Land Is Mine!</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;overflow:hidden;}
  #mainMenu{
    position:fixed;top:0;left:0;right:0;bottom:0;
    background:#000;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    gap:30px;z-index:1000;transition:opacity .5s;
    overflow:hidden;
  }
  .glow-text{
    font-size:4.5em;font-weight:bold;
    background:linear-gradient(90deg, #ff0000, #ffffff, #0066ff, #ff0000);
    background-size:300% 100%;
    -webkit-background-clip:text;
    background-clip:text;
    color:transparent;
    text-shadow:0 0 30px rgba(255,255,255,0.8), 0 0 60px rgba(255,0,0,0.6);
    animation:textWave 8s ease-in-out infinite, glowPulse 3s ease-in-out infinite;
    letter-spacing:0.05em;
  }
  .subtitle{
    font-size:1.6em;color:#ccc;text-shadow:0 0 15px rgba(255,255,255,0.5);
    animation:glowPulse 2.5s ease-in-out infinite;
  }
  #mainMenu button{
    background:linear-gradient(45deg, #001f3f, #007bff);
    color:#fff;border:2px solid #ffd700;padding:16px 36px;
    border-radius:12px;cursor:pointer;font-size:1.5em;font-weight:bold;
    transition:all .3s;box-shadow:0 6px 20px rgba(0,0,0,.6), 0 0 20px rgba(255,215,0,0.4);
    position:relative;overflow:hidden;
  }
  #mainMenu button::before{
    content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition:0.7s;
  }
  #mainMenu button:hover::before{left:100%;}
  #mainMenu button:hover{
    background:linear-gradient(45deg, #007bff, #001f3f);
    transform:scale(1.08);box-shadow:0 8px 25px rgba(0,0,0,.7), 0 0 30px rgba(255,215,0,0.7);
  }
  #mainMenu button:active{transform:scale(0.98);}
  #discordBtn{
    position:absolute;bottom:30px;right:30px;
    width:60px;height:60px;background:#5865F2;border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    box-shadow:0 0 20px rgba(88,101,242,0.8);cursor:pointer;
    transition:all .3s;animation:discordPulse 2s infinite;
  }
  #discordBtn:hover{transform:scale(1.15);box-shadow:0 0 30px rgba(88,101,242,1);}
  #discordBtn svg{width:36px;height:36px;fill:#fff;}
  #ui{
    position:fixed;top:8px;left:8px;z-index:10;
    background:rgba(0,0,0,.85);padding:12px;border-radius:8px;
    display:flex;gap:8px;flex-wrap:wrap;align-items:center;
    backdrop-filter:blur(12px);border:1px solid #444;
    transition:opacity .3s;font-size:14px;
  }
  #ui.hidden{opacity:0;pointer-events:none;}
  button{
    background:#333;color:#fff;border:1px solid #555;padding:8px 14px;
    border-radius:6px;cursor:pointer;font-size:13px;font-weight:bold;
    transition:all .2s;
  }
  button:hover{background:#555;border-color:#777;}
  button.active{background:#28a745;border-color:#28a745;}
  button.revolution{background:#001f3f;color:#fff;border:1px solid #007bff;}
  button.revolution:hover{background:#007bff;color:#fff;}
  #factions{display:flex;gap:4px;flex-wrap:wrap;max-width:600px;}
  .fac{
    padding:6px 10px;border-radius:6px;color:#fff;font-size:12px;cursor:pointer;
    display:flex;align-items:center;gap:4px;border:1px solid rgba(255,255,255,0.2);
  }
  .fac.selected{background:#28a745 !important;border-color:#fff !important;
    box-shadow:0 0 10px rgba(40,167,69,0.5);}
  .ally-icon{width:8px;height:8px;border-radius:50%;display:inline-block;}
  #log{
    position:fixed;bottom:8px;left:8px;right:8px;max-height:140px;overflow-y:auto;
    background:rgba(0,0,0,.85);padding:12px;border-radius:8px;font-size:12px;line-height:1.4;
    backdrop-filter:blur(12px);border:1px solid #333;
    transition:opacity .3s;
  }
  #log.hidden{opacity:0;pointer-events:none;}
  .popup{
    position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
    background:rgba(0,0,0,.95);padding:20px 32px;border-radius:12px;
    font-size:24px;font-weight:bold;text-align:center;z-index:100;
    animation:pop 0.7s ease-out forwards;
    box-shadow:0 0 30px rgba(255,255,255,.5);border:1px solid #555;
  }
  .napoleon-popup{
    background:linear-gradient(135deg,#001f3f,#007bff);
    color:#fff !important;font-size:28px !important;
    border:2px solid #ffd700 !important;box-shadow:0 0 40px #ffd700;
    animation:napoleonPop 1.2s ease-out forwards;
  }
  @keyframes pop{
    0%{transform:translate(-50%,-50%) scale(0.3);opacity:0;}
    70%{transform:translate(-50%,-50%) scale(1.15);}
    100%{transform:translate(-50%,-50%) scale(1);opacity:1;}
  }
  @keyframes napoleonPop{
    0%{transform:translate(-50%,-50%) scale(0.5) rotate(-10deg);opacity:0;}
    50%{transform:translate(-50%,-50%) scale(1.3) rotate(5deg);}
    100%{transform:translate(-50%,-50%) scale(1) rotate(0deg);opacity:1;}
  }
  #weather{
    position:fixed;top:8px;right:8px;background:rgba(0,0,0,.85);padding:10px;
    border-radius:8px;font-size:12px;backdrop-filter:blur(12px);border:1px solid #333;
    transition:opacity .3s;
  }
  #weather.hidden{opacity:0;pointer-events:none;}
  #history-panel{
    position:fixed;top:50%;right:8px;transform:translateY(-50%);
    background:rgba(0,0,0,.9);padding:12px;border-radius:8px;max-width:240px;
    max-height:320px;overflow-y:auto;font-size:11px;z-index:5;border:1px solid #333;
    transition:opacity .3s;
  }
  #history-panel.hidden{opacity:0;pointer-events:none;}
  .history-entry{color:#ccc;margin:2px 0;}
  .conflict-notice{
    color:#ff6666;font-size:10px;font-weight:bold;animation:conflictPop 1s ease-out;
    margin:2px 0;text-shadow:0 0 4px #ff4444;
  }
  @keyframes conflictPop{
    0%{opacity:0;transform:scale(0.6);}
    50%{transform:scale(1.1);}
    100%{opacity:1;transform:scale(1);}
  }
  canvas{image-rendering:pixelated;image-rendering:-moz-crisp-edges;
         image-rendering:crisp-edges;}
  .hint{color:#4CAF50;font-size:11px;font-style:italic;}
  .shockwave {
    position: fixed;
    border: 2px solid rgba(255, 0, 0, 0.8);
    border-radius: 50%;
    pointer-events: none;
    z-index: 50;
    animation: shockwave 0.8s ease-out forwards;
  }
  @keyframes shockwave {
    0% { transform: scale(0); opacity: 1; }
    100% { transform: scale(3); opacity: 0; }
  }
  @keyframes textWave {
    0%,100%{background-position:0% 50%;}
    50%{background-position:100% 50%;}
  }
  @keyframes glowPulse {
    0%,100%{text-shadow:0 0 20px rgba(255,255,255,0.6), 0 0 40px rgba(255,0,0,0.4);}
    50%{text-shadow:0 0 40px rgba(255,255,255,1), 0 0 80px rgba(0,102,255,0.8);}
  }
  @keyframes discordPulse {
    0%,100%{box-shadow:0 0 20px rgba(88,101,242,0.8);}
    50%{box-shadow:0 0 35px rgba(88,101,242,1);}
  }
</style>
</head>
<body>

<!-- MAIN MENU -->
<div id="mainMenu">
  <div class="glow-text">T.L.I.M!</div>
  <div class="subtitle">This Land Is Mine!</div>
  <button id="playBtn">Play Game</button>
  <button id="tutorialBtn">How to Play</button>
  <button id="creditsBtn">Credits</button>
  <div id="discordBtn" title="Join Discord">
    <svg viewBox="0 0 24 24"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/></svg>
  </div>
</div>

<!-- GAME UI -->
<div id="ui" class="hidden">
  <button id="menuBtn">Menu</button>
  <button id="resetBtn">New World</button>
  <button id="startBtn">Start</button>
  <button id="stopBtn">Pause</button>
  <button id="addBtn">Spawn</button>
  <button id="removeBtn">Remove</button>
  <button id="godBtn">God Mode</button>
  <button id="revolutionBtn" class="revolution">Reinforcements?</button>
  <button id="makeAllianceBtn">Ally</button>
  <button id="breakAllianceBtn">Break</button>
  <select id="buffSelect">
    <option value="1">1x</option>
    <option value="2">2x</option>
    <option value="3">3x</option>
    <option value="4">4x</option>
    <option value="5">5x</option>
    <option value="6">6x</option>
    <option value="7">7x</option>
    <option value="8">8x</option>
    <option value="9">9x</option>
    <option value="10">10x</option>
  </select>
  <button id="applyBuffBtn">Buff</button>
  <button id="zoomIn">Zoom +</button>
  <button id="zoomOut">Zoom -</button>
  <div id="factions"></div>
  <div class="hint">Press <b>F</b> to toggle HUD</div>
</div>
<canvas id="game"></canvas>
<div id="log" class="hidden"></div>
<div id="weather" class="hidden">Clear</div>
<div id="history-panel" class="hidden">
  <div id="history"></div>
  <div id="conflicts"></div>
</div>

<script>
// ====================== GLOBALS ======================
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const logDiv = document.getElementById('log');
const historyDiv = document.getElementById('history');
const conflictsDiv = document.getElementById('conflicts');
const mainMenu = document.getElementById('mainMenu');
const ui = document.getElementById('ui');
let MAP_W = 200, MAP_H = 120;
let pixelSize = 4;
let zoomLevel = 1.0;
let viewX = 0, viewY = 0;
let dragging = false;
let startDragX = 0, startDragY = 0;
let allyingMode = false;
let breakingMode = false;
let seed = Math.random() * 1000000;

// ----- Terrain -----
const TERRAIN = {DEEP_OCEAN:0, SHALLOW_WATER:5, PLAINS:1, FOREST:2, MOUNTAIN:3, DESERT:4};
const TERRAIN_COLORS = [[10,20,60], [40,60,120], [100,180,80], [60,120,60], [200,150,50], [80,140,180]];
const TERRAIN_ATTACK = {0:0,1:0.8,2:0.7,3:0.4,4:0.9,5:0.6};
const TERRAIN_DEFENSE = {0:0,1:1.0,2:1.4,3:2.0,4:1.2,5:1.8};

// ----- Weather -----
const WEATHER = { CLEAR:0, RAIN:1, STORM:2, FOG:3, SNOW:4 };
let currentWeather = WEATHER.CLEAR, weatherTick = 0;

// ----- Map data -----
let terrain = new Uint8Array(MAP_W*MAP_H);
let map = new Uint16Array(MAP_W*MAP_H);
let troops = new Uint8Array(MAP_W*MAP_H);
let navies = new Uint8Array(MAP_W*MAP_H);
let capitals = new Uint16Array(MAP_W*MAP_H);

// ----- Factions -----
let factions = [];
let selectedFaction = null;
let running = false, frameId = null, tick = 0;
let warDeclarations = new Map();
let historyLog = [];
let godMode = false;
let lastBetrayalTick = 0;
let napoleonActive = false;
let hudHidden = true;
let audioContext = null;

// ----- Tactics -----
const TACTICS = { BLITZKRIEG: 0, FORTRESS: 1, GUERRILLA: 2, NAVAL: 3, BALANCED: 4 };
const TACTIC_NAMES = ['Blitzkrieg', 'Fortress', 'Guerrilla', 'Naval', 'Balanced'];

// ====================== HELPERS ======================
function idx(x,y){ return y*MAP_W + x; }
function randomColor(){ return '#'+Math.floor(Math.random()*0xffffff).toString(16).padStart(6,'0'); }
function hexToRgb(hex){
  const n = parseInt(hex.slice(1),16);
  return [n>>16 & 255, n>>8 & 255, n & 255];
}
function randomNationName(){
  const pre = ['Neo','Greater','United','Soviet','Imperial','Free','People\'s','Holy','Ancient','Iron','Steel','Golden','Shadow','Storm'];
  const suf = ['Empire','Republic','Federation','Kingdom','Alliance','Confederacy','Syndicate','Caliphate','Hegemony','Legion','Phalanx','Dominion','Coalition','Order'];
  return pre[Math.floor(Math.random()*pre.length)]+' '+suf[Math.floor(Math.random()*suf.length)];
}
function log(msg){
  const p = document.createElement('div'); p.innerHTML = msg; logDiv.appendChild(p);
  logDiv.scrollTop = logDiv.scrollHeight;
  historyLog.unshift({time:tick,msg});
  if(historyLog.length>30) historyLog.pop();
  updateHistoryUI();
}
function updateHistoryUI(){
  historyDiv.innerHTML = historyLog.map(e=>`<div class="history-entry">[${e.time}] ${e.msg}</div>`).join('');
}
function warKey(a,b){ return a<b?`${a}-${b}`:`${b}-${a}`; }
function showConflict(a,b){
  const key = warKey(a,b);
  if(warDeclarations.has(key) && warDeclarations.get(key) > tick) return;
  warDeclarations.set(key, tick + 180);
  const el = document.createElement('div');
  el.className = 'conflict-notice';
  el.innerHTML = `WAR: ${factions[a].name} vs ${factions[b].name}`;
  conflictsDiv.insertBefore(el, conflictsDiv.firstChild);
  setTimeout(()=>el.remove(), 3000);
  createShockwave(factions[a].capitalX, factions[a].capitalY);
  createShockwave(factions[b].capitalX, factions[b].capitalY);
}
function popup(msg,color='#fff',special=false){
  const el = document.createElement('div');
  el.className = special ? 'popup napoleon-popup' : 'popup';
  el.style.color = color;
  el.innerHTML = msg;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), special?4000:2000);
}
function toggleHUD(){
  hudHidden = !hudHidden;
  const elements = [ui, logDiv, document.getElementById('weather'), document.getElementById('history-panel')];
  elements.forEach(el => el.classList.toggle('hidden', hudHidden));
}
function createShockwave(x, y){
  const sw = MAP_W * pixelSize;
  const sh = MAP_H * pixelSize;
  const offsetX = (canvas.width - sw) / 2 + viewX;
  const offsetY = (canvas.height - sh) / 2 + viewY;
  const px = offsetX + x * pixelSize + pixelSize / 2;
  const py = offsetY + y * pixelSize + pixelSize / 2;
  const el = document.createElement('div');
  el.className = 'shockwave';
  el.style.left = (px - pixelSize) + 'px';
  el.style.top = (py - pixelSize) + 'px';
  el.style.width = (pixelSize * 2) + 'px';
  el.style.height = (pixelSize * 2) + 'px';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 800);
}
function playNapoleonSound(){
  if(audioContext) audioContext.close();
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();
  osc.connect(gain); gain.connect(audioContext.destination);
  osc.frequency.setValueAtTime(440, audioContext.currentTime);
  osc.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + 0.5);
  gain.gain.setValueAtTime(0.3, audioContext.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
  osc.start(); osc.stop(audioContext.currentTime + 0.5);
}

// ====================== MAIN MENU ======================
document.getElementById('playBtn').onclick = () => {
  mainMenu.style.opacity = '0';
  setTimeout(() => mainMenu.style.display = 'none', 500);
  hudHidden = false;
  toggleHUD();
  startGame();
};
document.getElementById('tutorialBtn').onclick = () => {
  alert(`T.L.I.M! - This Land Is Mine!
- Watch nations fight for control
- Click "Start" to begin
- Select a nation to control it
- Use "Ally" / "Break" for diplomacy
- "God Mode" lets you paint land
- "Reinforcements?" requires code: "reinforcements"
- Buff any nation up to 10x
- Drag to pan, scroll to zoom
- Press F to toggle HUD
Claim your land!`);
};
document.getElementById('creditsBtn').onclick = () => {
  alert(`made by moccasin. discord is moccasin.1 hit me up ladies!!!`);
};
document.getElementById('menuBtn').onclick = () => {
  running = false;
  mainMenu.style.display = 'flex';
  setTimeout(() => mainMenu.style.opacity = '1', 50);
  hudHidden = true;
  toggleHUD();
};
document.getElementById('discordBtn').onclick = () => {
  window.open('https://discord.gg/Vme4AgYGnY', '_blank');
};

// ====================== CODE INPUT FOR REVOLUTION ======================
let revolutionCode = '';
document.getElementById('revolutionBtn').onclick = () => {
  if(napoleonActive){ popup('Reinforcements already deployed!','#ff9800'); return; }
  if(revolutionCode === 'reinforcements'){
    deployReinforcements();
  } else {
    const input = prompt('Enter code for reinforcements:');
    if(input && input.toLowerCase() === 'reinforcements'){
      revolutionCode = 'reinforcements';
      popup('Code accepted! Reinforcements ready!','#4CAF50');
      deployReinforcements();
    } else {
      popup('aw join the discord server to find the code xd','#ff9800');
    }
  }
};
function deployReinforcements(){
  let france = factions.find(f=>f.name.includes('French'));
  if(!france){
    spawnNation(true);
    france = factions[factions.length-1];
  }
  napoleonActive = true;
  france.napoleonBoost = 3.0;
  france.aggression = 1.8;
  france.tactic = TACTICS.BLITZKRIEG;
  for(let i=0;i<map.length;i++){
    if(map[i]===france.id){
      if(terrain[i]===TERRAIN.SHALLOW_WATER) navies[i] = Math.min(9,navies[i]*2);
      else troops[i] = Math.min(9,troops[i]*2);
    }
  }
  popup('REINFORCEMENTS ARRIVE!','#ffd700',true);
  log('REINFORCEMENTS bolster France with 3x power and Blitzkrieg tactics!');
  playNapoleonSound();
  updateFactionUI(); drawMap();
}

// ====================== WORLD GEN ======================
function generateWorld(){
  seed = Math.random() * 1000000;
  const noise = new Float32Array(MAP_W*MAP_H);
  const scale = 0.06 + Math.random() * 0.03;
  const octaves = 3 + Math.floor(Math.random() * 3);
  for(let y=0;y<MAP_H;y++) for(let x=0;x<MAP_W;x++){
    let val=0, amp=1, freq=scale;
    for(let i=0;i<octaves;i++){
      const nx = (x + seed) * freq;
      const ny = (y + seed * 0.7) * freq;
      val += Math.sin(nx) * Math.cos(ny) * amp;
      amp *= 0.5; freq *= 2;
    }
    noise[idx(x,y)] = val;
  }
  let min=Infinity, max=-Infinity;
  for(let i=0;i<noise.length;i++){
    min = Math.min(min,noise[i]);
    max = Math.max(max,noise[i]);
  }
  for(let i=0;i<noise.length;i++){
    const n = (noise[i]-min)/(max-min);
    if(n<0.18) terrain[i]=TERRAIN.DEEP_OCEAN;
    else if(n<0.25) terrain[i]=TERRAIN.SHALLOW_WATER;
    else if(n<0.48) terrain[i]=TERRAIN.PLAINS;
    else if(n<0.68) terrain[i]=TERRAIN.FOREST;
    else if(n<0.83) terrain[i]=TERRAIN.DESERT;
    else terrain[i]=TERRAIN.MOUNTAIN;
  }
}

// ====================== WEATHER ======================
function updateWeather(){
  weatherTick++;
  if(weatherTick>300){
    currentWeather = Math.floor(Math.random()*5);
    weatherTick=0;
    document.getElementById('weather').innerHTML = ['Clear','Rain','Storm','Fog','Snow'][currentWeather];
    log(`Weather: ${['Clear','Rain','Storm','Fog','Snow'][currentWeather]}`);
  }
}
function getWeatherMods(){
  switch(currentWeather){
    case WEATHER.RAIN: return {atk:0.85,def:1.1,grow:0.9};
    case WEATHER.STORM: return {atk:0.6,def:1.4,grow:0.6};
    case WEATHER.FOG: return {atk:0.9,def:1.0,grow:1.0};
    case WEATHER.SNOW: return {atk:0.8,def:1.2,grow:0.8};
    default: return {atk:1.0,def:1.0,grow:1.0};
  }
}

// ====================== FACTION ======================
class Faction{
  constructor(id,color,capX,capY,name){
    this.id=id; this.color=color; this.rgb=hexToRgb(color);
    this.name=name||randomNationName();
    this.allies=new Set(); this.cells=0; this.totalTroops=0; this.totalNavies=0;
    this.capitalX=capX; this.capitalY=capY; this.alive=true;
    this.napoleonBoost = 1.0;
    this.aggression = 1.0 + Math.random() * 0.5;
    this.preferredWeather = Math.floor(Math.random() * 5);
    this.tactic = Math.floor(Math.random() * 5);
    this.tacticAge = 0;
    this.tacticChangeTick = 500 + Math.floor(Math.random() * 1000);
  }
  getTacticMods(){
    switch(this.tactic){
      case TACTICS.BLITZKRIEG: return {atk:1.15, def:0.95, grow:1.25, terrain:1.0};
      case TACTICS.FORTRESS: return {atk:0.85, def:1.35, grow :0.75, terrain:1.3};
      case TACTICS.GUERRILLA: return {atk:1.05, def:1.05, grow:0.95, terrain:1.4};
      case TACTICS.NAVAL: return {atk:1.10, def:1.10, grow:0.90, terrain:1.0};
      default: return {atk:1.0, def:1.0, grow:1.0, terrain:1.0};
    }
  }
  updateTactic(){
    this.tacticAge++;
    if(this.tacticAge > this.tacticChangeTick){
      const old = TACTIC_NAMES[this.tactic];
      this.tactic = Math.floor(Math.random() * 5);
      this.tacticAge = 0;
      this.tacticChangeTick = 500 + Math.floor(Math.random() * 1000);
      log(`${this.name} switches from ${old} to ${TACTIC_NAMES[this.tactic]}`);
    }
  }
}

// ====================== SPAWN NATION ======================
function spawnNation(isFrance=false){
  const col = isFrance ? '#001f3f' : randomColor();
  const name = isFrance ? 'French Empire' : randomNationName();
  let x,y,i,attempts=0;
  do{
    x=Math.floor(Math.random()*MAP_W);
    y=Math.floor(Math.random()*MAP_H);
    i=idx(x,y);
    attempts++;
    if(attempts>2000) { log('No free land!'); return; }
  }while(map[i]!==0 || terrain[i]===TERRAIN.DEEP_OCEAN || terrain[i]===TERRAIN.SHALLOW_WATER);
  const f = new Faction(factions.length,col,x,y,name);
  factions.push(f);
  placeCapital(f,x,y);
  if(isFrance) selectedFaction=f.id;
  log(`${f.name} founded at (${x},${y}) using ${TACTIC_NAMES[f.tactic]}`);
  updateFactionUI(); drawMap();
}
function placeCapital(f,x,y){
  const i=idx(x,y);
  map[i]=f.id; troops[i]=10; capitals[i]=1;
  f.cells=1; f.totalTroops=10;
}

// ====================== BETRAYAL ======================
function checkBetrayals(){
  if(tick-lastBetrayalTick<600) return;
  factions.forEach(f=>{
    if(!f.alive || Math.random()>0.001) return;
    const allyIds = Array.from(f.allies);
    if(!allyIds.length) return;
    const betrayId = allyIds[Math.floor(Math.random()*allyIds.length)];
    const betrayF = factions[betrayId];
    if(!betrayF.alive) return;
    f.allies.delete(betrayId);
    betrayF.allies.delete(f.id);
    showConflict(f.id, betrayId);
    log(`${f.name} BETRAYS ${betrayF.name}!`);
    lastBetrayalTick = tick;
  });
}

// ====================== MAP DRAW ======================
const img = ctx.createImageData(MAP_W,MAP_H);
const data = img.data;
function drawMap(){
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  for(let i=0;i<map.length;i++){
    const base=i*4;
    const fid=map[i];
    const t=terrain[i];
    let [r,g,b]=TERRAIN_COLORS[t];
    if(fid!==0 && factions[fid] && factions[fid].alive){
      const rgb = factions[fid].rgb;
      const blend = (t===TERRAIN.DEEP_OCEAN||t===TERRAIN.SHALLOW_WATER)?0.4:0.6;
      r=r*(1-blend)+rgb[0]*blend;
      g=g*(1-blend)+rgb[1]*blend;
      b=b*(1-blend)+rgb[2]*blend;
      if(napoleonActive && factions[fid].name.includes('French')){
        const pulse = 0.3 + 0.2*Math.sin(tick*0.2);
        r = Math.min(255, r + 40*pulse);
        g = Math.min(255, g + 30*pulse);
        b = Math.min(255, b + 60*pulse);
      }
    }
    data[base]=r; data[base+1]=g; data[base+2]=b; data[base+3]=255;
  }
  ctx.putImageData(img,0,0);
  ctx.imageSmoothingEnabled=false;
  const sw = MAP_W * pixelSize;
  const sh = MAP_H * pixelSize;
  ctx.save();
  ctx.translate(viewX, viewY);
  ctx.drawImage(canvas,0,0,MAP_W,MAP_H, 0, 0, sw, sh);
  ctx.font=`${pixelSize*0.6}px bold Arial`;
  ctx.textAlign='center'; ctx.textBaseline='middle';
  for(let y=0;y<MAP_H;y++) for(let x=0;x<MAP_W;x++){
    const i=idx(x,y);
    const landT=troops[i];
    const navyT=navies[i];
    const isCap=capitals[i];
    const px= x*pixelSize + pixelSize/2;
    const py= y*pixelSize + pixelSize/2;
    if(landT>0 && ![TERRAIN.DEEP_OCEAN,TERRAIN.SHALLOW_WATER].includes(terrain[i])){
      ctx.fillStyle = landT>=5?'#fff':'#000';
      ctx.fillText(landT, px-pixelSize*0.2, py-pixelSize*0.2);
    }
    if(navyT>0 && terrain[i]===TERRAIN.SHALLOW_WATER){
      ctx.fillStyle = navyT>=5?'#fff':'#000';
      ctx.fillText(navyT, px+pixelSize*0.2, py+pixelSize*0.2);
    }
    if(isCap){
      ctx.font=`${pixelSize*0.9}px Arial`;
      ctx.fillStyle='#ffeb3b';
      ctx.strokeStyle='#000';
      ctx.lineWidth = pixelSize*0.15;
      ctx.strokeText('Star', px, py);
      ctx.fillText('Star', px, py);
    }
  }
  ctx.restore();
}

// ====================== SIMULATION ======================
function step(){
  const alive = factions.filter(f=>f.alive);
  if(alive.length<=1){
    running=false;
    if(alive[0]) popup(`${alive[0].name} conquers the world!`,'#4CAF50');
    return;
  }
  tick++; updateWeather();
  const newMap = new Uint16Array(map);
  const newTroops = new Uint8Array(troops);
  const newNavies = new Uint8Array(navies);
  const dirs=[[1,0],[-1,0],[0,1],[0,-1]];
  let changed=false;
  factions.forEach(f=>{if(f.alive){f.cells=0;f.totalTroops=0;f.totalNavies=0; f.updateTactic();}});
  if(tick%30===0) checkBetrayals();
  const wmod = getWeatherMods();
  const weatherBoost = (faction) => (faction && currentWeather === faction.preferredWeather ? 1.2 : 1.0);
  /* Growth */
  for(let i=0;i<map.length;i++){
    const fid=map[i];
    if(!fid||!factions[fid].alive) continue;
    const f=factions[fid];
    const tmods = f.getTacticMods();
    const chance = 0.35 * wmod.grow * f.napoleonBoost * f.aggression * weatherBoost(f) * tmods.grow;
    const isWater = terrain[i]===TERRAIN.SHALLOW_WATER;
    const troopsHere = isWater ? navies[i] : troops[i];
    if(capitals[i] && Math.random()<chance*1.8 && troopsHere<9){
      if(isWater){ newNavies[i]++; f.totalNavies++; }
      else{ newTroops[i]++; f.totalTroops++; }
      changed=true;
    }else if(Math.random()<chance && troopsHere<9){
      if(isWater){ newNavies[i]++; f.totalNavies++; }
      else{ newTroops[i]++; f.totalTroops++; }
      changed=true;
    }
  }
  /* Alliances */
  alive.forEach(f=>{
    if (tick % 800 !== 0 || Math.random() > 0.003) return;
    const possible = alive.filter(o => o.id !== f.id && !f.allies.has(o.id) && o.cells > 5 && f.cells > 5);
    if (!possible.length) return;
    const ally = possible[Math.floor(Math.random() * possible.length)];
    f.allies.add(ally.id); ally.allies.add(f.id);
    log(`${f.name} allies with ${ally.name}`);
  });
  /* Combat & Expansion */
  for(let y=0;y<MAP_H;y++) for(let x=0;x<MAP_W;x++){
    const i=idx(x,y);
    const fid=map[i];
    if(!fid||!factions[fid].alive) continue;
    const f=factions[fid];
    const tmods = f.getTacticMods();
    const isWater = terrain[i]===TERRAIN.SHALLOW_WATER;
    const att = isWater ? navies[i] : troops[i];
    if(att<=1) continue;
    for(const [dx,dy] of dirs){
      const nx=x+dx, ny=y+dy;
      if(nx<0||ny<0||nx>=MAP_W||ny>=MAP_H) continue;
      const ni=idx(nx,ny);
      const other=map[ni];
      if(other===fid || (factions[other] && f.allies.has(other))) continue;
      if(terrain[ni]===TERRAIN.DEEP_OCEAN || isWater !== (terrain[ni]===TERRAIN.SHALLOW_WATER)) continue;
      if(factions[other] && (!warDeclarations.has(warKey(fid,other)) || warDeclarations.get(warKey(fid,other))<tick)){
        showConflict(fid, other);
      }
      const def = terrain[ni]===TERRAIN.SHALLOW_WATER ? navies[ni] : troops[ni];
      const isCapAttack=capitals[ni];
      const attMod = TERRAIN_ATTACK[terrain[i]]*wmod.atk*f.napoleonBoost*f.aggression * weatherBoost(f) * tmods.atk;
      const defMod = TERRAIN_DEFENSE[terrain[ni]]*wmod.def * weatherBoost(factions[other]) * (factions[other]?.getTacticMods().def || 1);
      const effAtk = Math.floor(att*attMod);
      let effDef = Math.floor(def*defMod);
      if(isCapAttack) effDef *= 1.5;
      let chance = 0.85 * wmod.atk * f.aggression * tmods.atk;
      if(isCapAttack) chance = 0.98; else if(effAtk > effDef) chance = 0.92;
      chance *= weatherBoost(f);
      if(Math.random() >= chance) continue;
      if(effAtk > effDef){
        newMap[ni]=fid;
        if(isWater) newNavies[ni]=Math.max(1,effAtk-effDef);
        else newTroops[ni]=Math.max(1,effAtk-effDef);
        if(isWater) newNavies[i]=Math.max(1,att-Math.floor((effAtk-effDef)/2));
        else newTroops[i]=Math.max(1,att-Math.floor((effAtk-effDef)/2));
        changed=true;
        if(isCapAttack){
          capitals[ni]=0;
          factions[other].alive=false;
          popup(`${f.name} captures ${factions[other].name}'s capital!`,'#ff1744');
          log(`${f.name} conquers ${factions[other].name}`);
          createShockwave(nx, ny);
          for(let j=0;j<map.length;j++){
            if(map[j]===other){
              newMap[j]=0;
              newTroops[j]=0;
              newNavies[j]=0;
            }
          }
        }
      }
    }
  }
  for(let y=0;y<MAP_H;y++) for(let x=0;x<MAP_W;x++){
    const i=idx(x,y);
    const fid=map[i];
    if(!fid||!factions[fid].alive) continue;
    const f=factions[fid];
    const isWater = terrain[i]===TERRAIN.SHALLOW_WATER;
    const att = isWater ? navies[i] : troops[i];
    if(att<=2) continue;
    for(const [dx,dy] of dirs){
      const nx=x+dx, ny=y+dy;
      if(nx<0||ny<0||nx>=MAP_W||ny>=MAP_H) continue;
      const ni=idx(nx,ny);
      if(map[ni]!==0 || terrain[ni]===TERRAIN.DEEP_OCEAN || isWater !== (terrain[ni]===TERRAIN.SHALLOW_WATER)) continue;
      if(Math.random() < 0.7 * f.aggression * weatherBoost(f) * f.getTacticMods().grow){
        newMap[ni]=fid;
        if(isWater) newNavies[ni]=1; else newTroops[ni]=1;
        if(isWater) newNavies[i]=Math.max(1,att-1); else newTroops[i]=Math.max(1,att-1);
        changed=true;
      }
    }
  }
  for(let i=0;i<map.length;i++){
    if(map[i]!==newMap[i] || troops[i]!==newTroops[i] || navies[i]!==newNavies[i]) changed=true;
    if(newMap[i] && factions[newMap[i]].alive){
      const f=factions[newMap[i]];
      f.cells++; f.totalTroops+=newTroops[i]; f.totalNavies+=newNavies[i];
    }
  }
  map.set(newMap); troops.set(newTroops); navies.set(newNavies);
  if(changed) updateFactionUI();
  drawMap();
  if(running) frameId=requestAnimationFrame(step);
}

// ====================== UI ======================
function updateFactionUI(){
  const cont=document.getElementById('factions');
  cont.innerHTML='';
  factions.forEach((f,i)=>{
    if(!f.alive) return;
    const el=document.createElement('div');
    el.className='fac';
    el.style.backgroundColor=f.color;
    const allies=Array.from(f.allies).map(a=>`<span class="ally-icon" style="background:${factions[a].color};" title="${factions[a].name}"></span>`).join('');
    const cap=capitals[idx(f.capitalX,f.capitalY)]?' Star':''; // Star symbol
    const boost = f.napoleonBoost>1?` <b style="color:#ffd700">x${f.napoleonBoost}</b>`:'';
    const tactic = ` <b style="color:#00ffff">${TACTIC_NAMES[f.tactic]}</b>`;
    el.innerHTML=`<b>${f.name}</b>${boost}${tactic} ${f.cells}c/${f.totalTroops}L${f.totalNavies}N${cap} ${allies}`;
    if(i===selectedFaction) el.classList.add('selected');
    el.onclick=()=>{
      if(allyingMode){
        if(i !== selectedFaction && !factions[selectedFaction].allies.has(i)){
          factions[selectedFaction].allies.add(i);
          factions[i].allies.add(selectedFaction);
          log(`${factions[selectedFaction].name} allies with ${f.name}`);
          allyingMode = false;
          updateFactionUI();
        }
      }else if(breakingMode){
        if(i !== selectedFaction && factions[selectedFaction].allies.has(i)){
          factions[selectedFaction].allies.delete(i);
          factions[i].allies.delete(selectedFaction);
          log(`${factions[selectedFaction].name} breaks alliance with ${f.name}`);
          breakingMode = false;
          updateFactionUI();
        }
      }else{
        selectedFaction=i; updateFactionUI();
      }
    };
    cont.appendChild(el);
  });
}

// ====================== BUTTONS ======================
document.getElementById('resetBtn').onclick = ()=>{
  running=false; map.fill(0); troops.fill(0); navies.fill(0); capitals.fill(0);
  factions=[]; selectedFaction=null; warDeclarations.clear(); tick=0; weatherTick=0;
  currentWeather=WEATHER.CLEAR; historyLog=[]; conflictsDiv.innerHTML='';
  lastBetrayalTick=0; napoleonActive=false; revolutionCode='';
  generateWorld(); updateWeather();
  for(let i=0;i<5;i++) spawnNation();
  log('New World Generated'); popup('World Ready!','#4CAF50'); drawMap();
};
document.getElementById('startBtn').onclick = ()=>{ if(!running){running=true;frameId=requestAnimationFrame(step);} };
document.getElementById('stopBtn').onclick = ()=>{ running=false; if(frameId) cancelAnimationFrame(frameId); };
document.getElementById('addBtn').onclick = ()=>spawnNation();
document.getElementById('removeBtn').onclick = ()=>{
  if(selectedFaction===null){ popup('Select a nation first!','#ff9800'); return; }
  const f = factions[selectedFaction];
  f.alive = false;
  for(let i=0;i<map.length;i++){
    if(map[i]===f.id){ map[i]=0; troops[i]=0; navies[i]=0; capitals[i]=0; }
  }
  if(napoleonActive && f.name.includes('French')) napoleonActive=false;
  log(`${f.name} removed`); selectedFaction=null; updateFactionUI(); drawMap();
};
document.getElementById('godBtn').onclick = ()=>{ godMode=!godMode; popup(godMode?'God Mode ON':'God Mode OFF',godMode?'#FFD700':'#666'); };
document.getElementById('makeAllianceBtn').onclick = ()=>{ if(selectedFaction===null){popup('Select first!','#ff9800');return;} allyingMode=true; breakingMode=false; popup('Click ally',' #2196f3'); };
document.getElementById('breakAllianceBtn').onclick = ()=>{ if(selectedFaction===null){popup('Select first!','#ff9800');return;} breakingMode=true; allyingMode=false; popup('Click to break','#f44336'); };
document.getElementById('applyBuffBtn').onclick = ()=>{
  if(selectedFaction===null){popup('Select first!','#ff9800');return;}
  const buff = parseInt(document.getElementById('buffSelect').value);
  factions[selectedFaction].napoleonBoost = buff;
  log(`${factions[selectedFaction].name} buffed to ${buff}x!`); updateFactionUI();
};
document.getElementById('zoomIn').onclick = ()=>{ zoomLevel += 0.2; resize(); };
document.getElementById('zoomOut').onclick = ()=>{ zoomLevel = Math.max(0.2, zoomLevel - 0.2); resize(); };

// ====================== MOUSE ======================
canvas.addEventListener('wheel', e => {
  e.preventDefault();
  zoomLevel += e.deltaY < 0 ? 0.2 : -0.2;
  zoomLevel = Math.max(0.2, zoomLevel);
  resize();
}, {passive: false});
canvas.addEventListener('mousedown', e => {
  dragging = true;
  startDragX = e.clientX - viewX;
  startDragY = e.clientY - viewY;
});
canvas.addEventListener('mousemove', e => {
  if (dragging) {
    viewX = e.clientX - startDragX;
    viewY = e.clientY - startDragY;
    clampView();
    drawMap();
  }
});
canvas.addEventListener('mouseup', () => dragging = false);
canvas.addEventListener('mouseleave', () => dragging = false);
canvas.addEventListener('click', e => {
  if(!godMode || selectedFaction===null) return;
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left - viewX;
  const my = e.clientY - rect.top - viewY;
  const x = Math.floor(mx / pixelSize);
  const y = Math.floor(my / pixelSize);
  if(x<0||x>=MAP_W||y<0||y>=MAP_H) return;
  const i = idx(x,y);
  if(capitals[i]){ alert('Cannot paint over capital!'); return; }
  if([TERRAIN.DEEP_OCEAN,TERRAIN.SHALLOW_WATER].includes(terrain[i])){ alert('Cannot claim water!'); return; }
  const f = factions[selectedFaction];
  map[i]=selectedFaction; troops[i]=3; f.cells++; f.totalTroops+=3;
  log(`${f.name} claims land`); drawMap(); updateFactionUI();
});
function clampView(){
  const sw = MAP_W * pixelSize;
  const sh = MAP_H * pixelSize;
  viewX = Math.min(0, Math.max(canvas.width - sw, viewX));
  viewY = Math.min(0, Math.max(canvas.height - sh, viewY));
}

// ====================== RESIZE ======================
function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  const base = Math.min(canvas.width / MAP_W, canvas.height / MAP_H);
  pixelSize = Math.max(1, Math.floor(base * zoomLevel));
  clampView();
  drawMap();
}
window.addEventListener('resize', resize);

// ====================== KEYBOARD ======================
document.addEventListener('keydown', e => {
  if(e.key === 'f' || e.key === 'F'){
    e.preventDefault();
    toggleHUD();
  }
});

// ====================== START GAME ======================
function startGame(){
  generateWorld(); updateWeather();
  for(let i=0;i<5;i++) spawnNation();
  selectedFaction=0; updateFactionUI(); resize();
  log('T.L.I.M! - This Land Is Mine! Press F to toggle HUD.');
}
</script>
</body>
</html>
